# yolink_bridge -- Bridge between YoLink MQTT broker and a local MQTT broker

This program creates a bridge between the YoLink MQTT broker and a local
MQTT broker to handle the YoLink authentication process and to provide
a more device centric structure for the topics.

Any program can connect to the local MQTT broker and make use of the
data.  However, some examples for OpenHAB are provided in the OpenHAB
directory.  Even if you don't use OpenHAB, the OpenHAB example files
show some examples of how to specify topics and payloads.

---

## Disclaimers

⚠️ This program was independently developed for personal use and has nothing
to do with the YoSmart company.

⚠️ No official support is provided for this program.

⚠️ I only have a few YoLink devices (SpeakerHub, LeakSensor, Manipulator).
Other devices should work.  But, they have not been tested.

⚠️ This script has only been tested on Linux.

---

## Overview

YoLink provides API and MQTT access to device data.  This program
focuses on the MQTT access.  However, to gain access to the MQTT data
on the YoLink server, an access token must be obtained from the API.
The access token will change over time and this adds complexity to the
connection process.  This extra step is not necessary if using a YoLink
Local Hub.  This program should handle either method (though, the Local
Hub connection has not been tested).  YoLink also provides a separate
interface for business partners.  That interface is not supported by
this program.

The YoLink MQTT interface only makes use of three topics.  A `request`
topic to send requests to YoLink and `response`/`report` topics to send
YoLink data to the client.  This program bridges those topics.  But,
it also breaks down `response`/`report` messages into multiple messages,
grouped by device, providing individual values via separate topics.
This makes it easier for client programs to access the data that they
are interested in.  Additionally, the `request` messages can also be sent
in a simplified form without specifying things like HOME-ID and TOKEN
(these are automatically determined by the bridge and inserted into the
messages sent to the YoLink server).

---

## Links

* YoLink website: <http://yosmart.com>
* YoLink API documentation: <http://doc.yosmart.com/docs/overall/intro>

---

## Prerequisites

* MQTT broker (Mosquitto or other)
* YoLink devices and YoLink credentials
* ruby

---
## CLI

    yolink_bridge [OPTIONS]

    Options:
    -c, --config-dir=        Location of config files (/home/ha/credentials)
    -l, --log-file=          Name of log file (defaults to stdout)
    -A, --print-access-token Print a UAC
    -H, --print-home-id      Print the home ID
    -D, --print-device-list  Print the list of devices
    -L, --no-local           Don't connect to local mqtt broker
    -Y, --no-yolink          Don't connect to yolink mqtt broker
    -v, --verbose            Print verbose output
    -x, --debug              Print debug output
    -h, --help               Print help message

---

## Configuration

Use the `--config-dir` option to specify the location where configuration
files are located.

Two configuration files are required:

- yolink.json

  Contains credential and connection information for the YoLink connection
  in JSON format.

  For connections to the YoLink server, `uaid` and `secret_key`
  are required.  These are available in the YoLink app
  (Settings->Account->Advanced Settings->Uesr Access Credentials).

  For connections to a YoLink local hub, `host`, `port`, `username`,
  `password`, `subnet_id` are required.

  Optional keys that can be set are: `keep_alive`

  - For connecting to YoLink server:

      ```json
        {
          "uaid":       "ua_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
          "secret_key": "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
        }
      ```
  - For connecting to a YoLink Local Hub:

      ```json
        {
          "host": "YOLINK-LOCAL-HUB-IP-ADDRESS",
          "port": 1080,
          "subnet_id": "YOLINK-LOCAL-HUB_SUBNET-ID",
          "username": "YOLINK-USERNAME",
          "password": "YOLINK-PASSWORD"
        }
      ```

- mqtt.json

  Contains credential and connection information for the local MQTT broker
  JSON format.

  `username` and `password` are required.
  Optional keys that can be set are: `host`, `port` and `keep_alive`.

  ```json
    {
      "username": "LOCAL-MQTT-USERNAME",
      "password": "LOCAL-MQTT-PASSWORD"
    }
  ```

---

## Messages:

### report

A report message is generated by the YoLink server when an unusual situation
is detected (i.e. leak detected).  The topic for the normal report message
does not contain the device ID of the device that triggered the report.  The
device information, state, etc. is contained in the JSON payload of the
message.  Each new message, essentially, overwrites, the previous message.

This bridge publishes the original, raw, report message to the local `yolink/report`
topic.

Additionally, it will break down that message and send a separate message for
each element of the report.  The topic will include the DEVICE-ID (i.e.
`yolink/DEVICE-ID/state`).  All of the elements are flattened to a single level
JSON hash (i.e. you don't have `state/state`).
Some elements, such as msgid and times, are omitted.

#### Example
- topic:   `yolink/DEVICE-ID/state`<br>
  payload: `"open"`

### response

Response messages are generated as a response to a client request.

The bridge publishes the original, raw, response message to the local
`yolink/response` topic.

Response messages are broken down identically to report messages.  If the
response is for Home or Manage requests, "home" or "manage" will replace the
DEVICE-ID in the topic.

### request

You will need to know the DEVICE-ID for a device to request data for it.
You can run `yolink_bridge --print-device-list` to see the device list.

Request messages can be sent in a variety of ways:

- `yolink/request`<br>
  A mostly standard YoLink request per the YoLink spec (HOME-ID or SUBNET-ID
  are automatically computed and added to the topic sent to YoLink).<br>
  For messages with a `targetDevice` specified, you can omit the
  `type` from the method as the type will be automatically added if not present
  (i.e.  use `setState` instead of `Manipulator.setState`).<br>
  For messages with a `targetDevice` specified, you can omit the `token`
  as that will also be compted and added to the message.<br>
  If the method is `setState`, the payload can be a simple string instead of
  a JSON string (i.e. `"close"`).
- `yolink/DEVICE-ID/request`<br>
  Request for a specific device.  The payload does not need to contain
  the DEVICE-ID since it is specified in the topic.
  The DEVICE-ID and the device's TOKEN are automatically inserted into
  the payload sent to YoLink.
- `yolink/DEVICE-ID/request/METHOD`<br>
  Same as above except that the METHOD from the topic is inserted into the
  YoLink payload automatically.
- `yolink/DEVICE-ID/request/METHOD/PARAMETER`<br>
  Same as above except that a parameter name is specified to use other
  than the `state` parameter.

#### Examples

- topic: `yolink/home/requset`<br>
  payload: `{ "method": "getDevices" }`

- topic: `yolink/DEVICE-ID/request`<br>
  payload: `{ "method": "setState", "params": {"state": "close"} }`

- topic: `yolink/DEVICE-ID/request/setState`<br>
  payload: { "state": "close" }

- topic: `yolink/DEVICE-ID/request/setState`<br>
  payload: "close"

- topic: `yolink/DEVICE-ID/request/setState/brightness`<br>
  payload: 50

---

## Installation

Ensure ruby is installed on your computer (i.e. `apt install ruby`).

cd to the program directory and run the command:<br>
```
bundle install
```

### Test runs

After setting up the config files, run the program:<br>
```
./yolink_bridge
```

If there are issues or you want to see what is going on under the hood, run:<br>
```
./yolink_bridge -v
```
Or:<br>
```
./yolink_bridge -xv
```

To run with a custom config directory and log file:<br>
```
./yolink_bridge --config-dir=DIR_CONFIG_FILES_ARE_IN --log=/var/log/yolink_bridge.log
```

### Run as daemon

There are two scripts provided to automatically start the program at boot time.
Edit the start_yolink_bridge and yolink_bridge.service scripts and fill in the
directory the program is located in, the location of the config directory and
the E-mail address to send messages to (if the program dies unexpectedly).  Then,
run the following commands:

```
systemctl --system daemon-reload
systemctl enable yolink_bridge.service
service yolink_bridge start
```

---

## Credits

Written by Bill Young
